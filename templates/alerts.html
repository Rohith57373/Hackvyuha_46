<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Alerts - SecureView</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>tailwind.config={theme:{extend:{colors:{primary:'#3b82f6',secondary:'#64748b'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px'}}}}</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
    <style>
        :where([class^="ri-"])::before { content: "\f3c2"; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .alert-item {
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        .alert-item:hover {
            background-color: #f9fafb;
        }
        .alert-critical {
            border-color: #ef4444;
        }
        .alert-warning {
            border-color: #f59e0b;
        }
        .alert-info {
            border-color: #3b82f6;
        }
        .alert-success {
            border-color: #10b981;
        }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 flex items-center justify-center text-primary">
                        <i class="ri-cctv-fill ri-2x"></i>
                    </div>
                    <h1 class="text-xl font-['Pacifico'] text-gray-800">SecureView</h1>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <div class="w-5 h-5 flex items-center justify-center text-gray-400">
                                <i class="ri-search-line"></i>
                            </div>
                        </div>
                        <input type="text" class="bg-gray-50 border-none text-gray-900 text-sm rounded-lg block w-64 pl-10 p-2.5 focus:ring-2 focus:ring-primary/20 focus:outline-none" placeholder="Search alerts...">
                    </div>
                    
                    <button class="relative p-2 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-full transition-colors">
                        <div class="w-6 h-6 flex items-center justify-center">
                            <i class="ri-notification-3-line"></i>
                        </div>
                        <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    
                    <button class="p-2 text-gray-600 hover:text-primary hover:bg-blue-50 rounded-full transition-colors">
                        <div class="w-6 h-6 flex items-center justify-center">
                            <i class="ri-settings-3-line"></i>
                        </div>
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gray-200 rounded-full overflow-hidden">
                            <img src="https://readdy.ai/api/search-image?query=professional%20headshot%20of%20a%20security%20officer%2C%20male%2C%2040s%2C%20serious%20expression%2C%20security%20uniform%2C%20high%20quality%20portrait&width=100&height=100&seq=1&orientation=squarish" alt="User profile" class="w-full h-full object-cover">
                        </div>
                        <span class="text-sm font-medium text-gray-700">James Wilson</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Navigation Bar -->
        <nav class="nav-container">
            <div class="container mx-auto">
                <div class="nav-menu">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="{{ url_for('index') }}" class="nav-link">
                                <div class="nav-icon">
                                    <i class="ri-dashboard-line"></i>
                                </div>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item nav-dropdown">
                            <a href="{{ url_for('create_room') }}" class="nav-link">
                                <div class="nav-icon">
                                    <i class="ri-cctv-line"></i>
                                </div>
                                <span>Cameras</span>
                            </a>
                            <div class="nav-dropdown-content">
                                <div class="nav-dropdown-header">
                                    <h3 class="text-sm font-medium text-gray-700">Available Videos</h3>
                                </div>
                                <div class="nav-dropdown-list">
                                    {% for id, camera in cameras.items() %}
                                    <a href="{{ url_for('index', camera_id=id) }}" class="nav-dropdown-item">
                                        <div class="camera-icon">
                                            <i class="ri-video-line"></i>
                                        </div>
                                        <span>{{ camera.title }}</span>
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                        </li>
                        <li class="nav-item">
                            <a href="{{ url_for('analytics') }}" class="nav-link">
                                <div class="nav-icon">
                                    <i class="ri-bar-chart-2-line"></i>
                                </div>
                                <span>Analytics</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ url_for('alerts') }}" class="nav-link active">
                                <div class="nav-icon">
                                    <i class="ri-alarm-warning-line"></i>
                                </div>
                                <span>Alerts</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="{{ url_for('user_profile') }}" class="nav-link">
                                <div class="nav-icon">
                                    <i class="ri-user-line"></i>
                                </div>
                                <span>Profile</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="flex-1 container mx-auto px-4 py-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">System Alerts</h1>
                <div class="flex items-center gap-2">
                    <button id="notificationSettingsBtn" class="px-3 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:bg-primary/90">
                        <i class="ri-notification-line mr-1.5"></i>Notification Settings
                    </button>
                    <button class="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-50">
                        <i class="ri-filter-3-line mr-1.5"></i>Filter
                    </button>
                </div>
            </div>
            
            <!-- Alert Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Critical</p>
                            <h3 id="criticalCount" class="text-2xl font-bold text-red-600">3</h3>
                        </div>
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500">
                            <i class="ri-error-warning-fill text-lg"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Warning</p>
                            <h3 id="warningCount" class="text-2xl font-bold text-yellow-500">7</h3>
                        </div>
                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-500">
                            <i class="ri-alert-line text-lg"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Info</p>
                            <h3 id="infoCount" class="text-2xl font-bold text-blue-500">12</h3>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-500">
                            <i class="ri-information-line text-lg"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Resolved</p>
                            <h3 id="resolvedCount" class="text-2xl font-bold text-green-500">24</h3>
                        </div>
                        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-500">
                            <i class="ri-checkbox-circle-line text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CPU Usage Monitor -->
            <div class="mb-6">
                <div class="card p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">CPU Usage</h2>
                        <span id="cpuStatus" class="px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full">Critical</span>
                    </div>
                    <div class="mb-4">
                        <div class="h-2.5 w-full bg-gray-200 rounded-full overflow-hidden">
                            <div id="cpuBar" class="h-full bg-red-500 rounded-full" style="width: 92%"></div>
                        </div>
                        <div class="flex justify-between mt-2">
                            <span id="cpuUsage" class="text-sm text-gray-500">Current: 92%</span>
                            <span id="cpuThreshold" class="text-sm font-medium text-red-600">Threshold: 85%</span>
                        </div>
                    </div>
                    <div class="chart-container mb-3">
                        <!-- CPU Chart will be rendered here using JavaScript -->
                        <canvas id="cpuChart"></canvas>
                    </div>
                    <p class="text-sm text-gray-600">CPU usage above 85% for more than 10 minutes. This might affect system performance and video processing capabilities.</p>
                    <div class="mt-4 flex items-center justify-between">
                        <span id="cpuLastUpdated" class="text-xs text-gray-500">Last updated: 2 minutes ago</span>
                        <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200 view-details-btn">View Details</button>
                    </div>
                </div>
            </div>
            
            <!-- System Alerts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Memory Alert -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">Memory Usage</h3>
                            <span class="px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Warning</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-700">78% (12.5 GB / 16 GB)</span>
                                <span class="text-sm text-yellow-600">Threshold: 80%</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-500 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Memory usage is approaching warning threshold. Consider optimizing AI processing workloads or scaling resources.</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Last updated: 5 minutes ago</span>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">View Details</button>
                        </div>
                    </div>
                </div>
                
                <!-- Disk Space Alert -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">Disk Space</h3>
                            <span class="px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full">Critical</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-700">95% (950 GB / 1 TB)</span>
                                <span class="text-sm text-red-600">Threshold: 90%</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-red-500 rounded-full" style="width: 95%"></div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Storage space critically low. Recorded footage may stop being saved soon. Please clean up old recordings or add additional storage.</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Last updated: 10 minutes ago</span>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">View Details</button>
                        </div>
                    </div>
                </div>
                
                <!-- Network Alert -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">Network Bandwidth</h3>
                            <span class="px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Warning</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-700">84 Mbps / 100 Mbps</span>
                                <span class="text-sm text-yellow-600">Threshold: 80 Mbps</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-yellow-500 rounded-full" style="width: 84%"></div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">High network utilization detected. This may affect streaming quality. Consider optimizing video compression or scaling network capacity.</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Last updated: 8 minutes ago</span>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">View Details</button>
                        </div>
                    </div>
                </div>
                
                <!-- AI Processing Alert -->
                <div class="card">
                    <div class="p-4 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">AI Processing Load</h3>
                            <span class="px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full">Critical</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <div class="flex justify-between mb-1">
                                <span class="text-sm text-gray-700">High model inference latency</span>
                                <span class="text-sm text-red-600">350ms > 200ms threshold</span>
                            </div>
                            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-red-500 rounded-full" style="width: 90%"></div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">AI processing is significantly delayed. This affects real-time detection capabilities. Auto-scaling additional GPU resources recommended.</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-500">Last updated: 3 minutes ago</span>
                            <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">View Details</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Alerts List -->
            <div class="card">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="font-semibold text-gray-800">Recent Alerts</h3>
                </div>
                <div id="alertsContainer" class="divide-y divide-gray-100">
                    <!-- Alert items will be dynamically inserted here -->
                    <div class="p-4 text-center text-gray-500">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-300 mb-2"></div>
                        <p>Loading alerts...</p>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-100">
                    <button id="viewAllAlertsBtn" class="w-full py-2 bg-gray-50 text-gray-700 text-sm font-medium rounded hover:bg-gray-100">
                        View All Alerts
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 py-4">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-500">Â© 2024 SecureView. All rights reserved.</p>
                    <div class="flex items-center gap-4">
                        <a href="#" class="text-sm text-gray-500 hover:text-primary">Privacy Policy</a>
                        <a href="#" class="text-sm text-gray-500 hover:text-primary">Terms of Service</a>
                        <a href="#" class="text-sm text-gray-500 hover:text-primary">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
        
        <!-- Notification Settings Modal -->
        <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg w-full max-w-md mx-4 overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Notification Settings</h3>
                    <button id="closeNotificationModal" class="text-gray-400 hover:text-gray-500">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                <div class="p-6">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700 font-medium">Enable Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="notificationsEnabled" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Receive alerts when system metrics exceed thresholds</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Email Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="emailEnabled" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">SMS Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="smsEnabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Push Notifications</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="pushEnabled" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <label for="cooldownMinutes" class="block text-sm font-medium text-gray-700 mb-1">Alert Cooldown Period</label>
                        <div class="flex items-center">
                            <input type="number" id="cooldownMinutes" min="1" max="60" value="15" 
                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <span class="ml-2 text-gray-500">minutes</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Minimum time between repeated alerts of the same type</p>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-200 flex justify-end">
                    <button id="cancelNotificationSettings" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md mr-2 hover:bg-gray-200">Cancel</button>
                    <button id="saveNotificationSettings" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let cpuChart;
        let metricsUpdateTimer;
        let lastUpdated = {};
        
        // Notification settings management
        const notificationModal = document.getElementById('notificationModal');
        const notificationSettingsBtn = document.getElementById('notificationSettingsBtn');
        const closeNotificationModal = document.getElementById('closeNotificationModal');
        const cancelNotificationSettings = document.getElementById('cancelNotificationSettings');
        const saveNotificationSettings = document.getElementById('saveNotificationSettings');
        
        // Toggle notification modal
        notificationSettingsBtn.addEventListener('click', function() {
            fetchNotificationSettings();
            notificationModal.classList.remove('hidden');
        });
        
        closeNotificationModal.addEventListener('click', function() {
            notificationModal.classList.add('hidden');
        });
        
        cancelNotificationSettings.addEventListener('click', function() {
            notificationModal.classList.add('hidden');
        });
        
        // Save notification settings
        saveNotificationSettings.addEventListener('click', async function() {
            const settings = {
                enabled: document.getElementById('notificationsEnabled').checked,
                email_enabled: document.getElementById('emailEnabled').checked,
                sms_enabled: document.getElementById('smsEnabled').checked,
                push_enabled: document.getElementById('pushEnabled').checked,
                cooldown_minutes: parseInt(document.getElementById('cooldownMinutes').value) || 15
            };
            
            try {
                const response = await fetch('/api/notification_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Notification settings updated:', data.settings);
                    notificationModal.classList.add('hidden');
                    
                    // Show a temporary success message
                    const alertElement = document.createElement('div');
                    alertElement.className = 'fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md transition-opacity duration-500';
                    alertElement.innerHTML = `
                        <div class="flex items-center">
                            <div class="mr-3">
                                <i class="ri-checkbox-circle-line text-lg"></i>
                            </div>
                            <div>
                                <p class="font-medium">Notification settings updated successfully</p>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(alertElement);
                    
                    // Remove the alert after 3 seconds
                    setTimeout(() => {
                        alertElement.style.opacity = '0';
                        setTimeout(() => alertElement.remove(), 500);
                    }, 3000);
                } else {
                    console.error('Failed to update notification settings:', data.error);
                }
            } catch (error) {
                console.error('Error saving notification settings:', error);
            }
        });
        
        // Fetch current notification settings
        async function fetchNotificationSettings() {
            try {
                const response = await fetch('/api/notification_settings');
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('notificationsEnabled').checked = settings.enabled;
                    document.getElementById('emailEnabled').checked = settings.email_enabled;
                    document.getElementById('smsEnabled').checked = settings.sms_enabled;
                    document.getElementById('pushEnabled').checked = settings.push_enabled;
                    document.getElementById('cooldownMinutes').value = settings.cooldown_minutes;
                } else {
                    console.error('Error fetching notification settings:', data.error);
                }
            } catch (error) {
                console.error('Failed to fetch notification settings:', error);
            }
        }

        // Function to fetch system metrics
        async function fetchSystemMetrics() {
            try {
                const response = await fetch('/api/system_metrics');
                const data = await response.json();
                
                if (data.success) {
                    updateMetricsDisplay(data.metrics);
                } else {
                    console.error('Error fetching metrics:', data.error);
                }
            } catch (error) {
                console.error('Failed to fetch system metrics:', error);
            }
        }
        
        // Function to update the UI with metrics data
        function updateMetricsDisplay(metrics) {
            // Update alert counts
            updateAlertCounts(metrics.alerts);
            
            // Update CPU data
            updateCpuData(metrics.cpu);
            
            // Update memory data
            updateMemoryData(metrics.memory);
            
            // Update disk data
            updateDiskData(metrics.disk);
            
            // Update network data
            updateNetworkData(metrics.network);
            
            // Update AI processing data
            updateAiProcessingData(metrics.ai_processing);
            
            // Update GPU temperature
            updateGpuTemperature(metrics.gpu);
            
            // Update timestamps
            updateTimestamps(metrics);
        }
        
        function updateAlertCounts(alerts) {
            document.getElementById('criticalCount').textContent = alerts.critical;
            document.getElementById('warningCount').textContent = alerts.warning;
            document.getElementById('infoCount').textContent = alerts.info;
            document.getElementById('resolvedCount').textContent = alerts.resolved;
        }
        
        function updateCpuData(cpuData) {
            // Update CPU usage bar
            const cpuBar = document.getElementById('cpuBar');
            const cpuUsage = document.getElementById('cpuUsage');
            const cpuThreshold = document.getElementById('cpuThreshold');
            
            cpuBar.style.width = cpuData.current + '%';
            cpuUsage.textContent = 'Current: ' + cpuData.current + '%';
            cpuThreshold.textContent = 'Threshold: ' + cpuData.threshold + '%';
            
            // Update Status Indicator
            const cpuStatusIndicator = document.getElementById('cpuStatus');
            if (cpuData.current > cpuData.threshold) {
                cpuStatusIndicator.className = 'px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                cpuStatusIndicator.textContent = 'Critical';
                cpuBar.className = 'h-full bg-red-500 rounded-full';
            } else if (cpuData.current > cpuData.threshold * 0.9) {
                cpuStatusIndicator.className = 'px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                cpuStatusIndicator.textContent = 'Warning';
                cpuBar.className = 'h-full bg-yellow-500 rounded-full';
            } else {
                cpuStatusIndicator.className = 'px-2.5 py-0.5 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                cpuStatusIndicator.textContent = 'Normal';
                cpuBar.className = 'h-full bg-green-500 rounded-full';
            }
            
            // Update CPU chart
            if (cpuChart) {
                cpuChart.data.datasets[0].data = cpuData.history;
                cpuChart.update();
            } else {
                const ctx = document.getElementById('cpuChart').getContext('2d');
                cpuChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(cpuData.history.length).fill(''),
                        datasets: [{
                            label: 'CPU Usage %',
                            data: cpuData.history,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: {
                                    display: false
                                }
                            },
                            x: {
                                display: false
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                
                // Add threshold line
                cpuChart.data.datasets.push({
                    label: 'Threshold',
                    data: Array(cpuData.history.length).fill(cpuData.threshold),
                    borderColor: '#10b981',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                });
                
                cpuChart.update();
            }
            
            // Update last updated time
            lastUpdated.cpu = new Date();
            document.getElementById('cpuLastUpdated').textContent = 'Last updated: Just now';
        }
        
        function updateMemoryData(memoryData) {
            // Update memory usage bar
            const memoryBar = document.getElementById('memoryBar');
            const memoryUsage = document.getElementById('memoryUsage');
            const memoryThreshold = document.getElementById('memoryThreshold');
            
            memoryBar.style.width = memoryData.current + '%';
            memoryUsage.textContent = memoryData.current + '% (' + memoryData.used + ' GB / ' + memoryData.total + ' GB)';
            memoryThreshold.textContent = 'Threshold: ' + memoryData.threshold + '%';
            
            // Update Status Indicator
            const memoryStatus = document.getElementById('memoryStatus');
            if (memoryData.current > memoryData.threshold) {
                memoryStatus.className = 'px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                memoryStatus.textContent = 'Critical';
                memoryBar.className = 'h-full bg-red-500 rounded-full';
            } else if (memoryData.current > memoryData.threshold * 0.9) {
                memoryStatus.className = 'px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                memoryStatus.textContent = 'Warning';
                memoryBar.className = 'h-full bg-yellow-500 rounded-full';
            } else {
                memoryStatus.className = 'px-2.5 py-0.5 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                memoryStatus.textContent = 'Normal';
                memoryBar.className = 'h-full bg-green-500 rounded-full';
            }
            
            // Update last updated time
            lastUpdated.memory = new Date();
            document.getElementById('memoryLastUpdated').textContent = 'Last updated: Just now';
        }
        
        function updateDiskData(diskData) {
            // Update disk usage bar
            const diskBar = document.getElementById('diskBar');
            const diskUsage = document.getElementById('diskUsage');
            const diskThreshold = document.getElementById('diskThreshold');
            
            diskBar.style.width = diskData.current + '%';
            diskUsage.textContent = diskData.current + '% (' + diskData.used + ' GB / ' + diskData.total + ' GB)';
            diskThreshold.textContent = 'Threshold: ' + diskData.threshold + '%';
            
            // Update Status Indicator
            const diskStatus = document.getElementById('diskStatus');
            if (diskData.current > diskData.threshold) {
                diskStatus.className = 'px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                diskStatus.textContent = 'Critical';
                diskBar.className = 'h-full bg-red-500 rounded-full';
            } else if (diskData.current > diskData.threshold * 0.9) {
                diskStatus.className = 'px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                diskStatus.textContent = 'Warning';
                diskBar.className = 'h-full bg-yellow-500 rounded-full';
            } else {
                diskStatus.className = 'px-2.5 py-0.5 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                diskStatus.textContent = 'Normal';
                diskBar.className = 'h-full bg-green-500 rounded-full';
            }
            
            // Update last updated time
            lastUpdated.disk = new Date();
            document.getElementById('diskLastUpdated').textContent = 'Last updated: Just now';
        }
        
        function updateNetworkData(networkData) {
            // Update network usage bar
            const networkBar = document.getElementById('networkBar');
            const networkUsage = document.getElementById('networkUsage');
            const networkThreshold = document.getElementById('networkThreshold');
            
            networkBar.style.width = networkData.current + '%';
            networkUsage.textContent = networkData.current + ' Mbps / 100 Mbps';
            networkThreshold.textContent = 'Threshold: ' + networkData.threshold + ' Mbps';
            
            // Update Status Indicator
            const networkStatus = document.getElementById('networkStatus');
            if (networkData.current > networkData.threshold) {
                networkStatus.className = 'px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                networkStatus.textContent = 'Critical';
                networkBar.className = 'h-full bg-red-500 rounded-full';
            } else if (networkData.current > networkData.threshold * 0.9) {
                networkStatus.className = 'px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                networkStatus.textContent = 'Warning';
                networkBar.className = 'h-full bg-yellow-500 rounded-full';
            } else {
                networkStatus.className = 'px-2.5 py-0.5 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                networkStatus.textContent = 'Normal';
                networkBar.className = 'h-full bg-green-500 rounded-full';
            }
            
            // Update last updated time
            lastUpdated.network = new Date();
            document.getElementById('networkLastUpdated').textContent = 'Last updated: Just now';
        }
        
        function updateAiProcessingData(aiData) {
            // Update AI processing bar
            const aiBar = document.getElementById('aiBar');
            const aiLatency = document.getElementById('aiLatency');
            const aiThreshold = document.getElementById('aiThreshold');
            
            const percentage = Math.min((aiData.latency / aiData.threshold) * 100, 100);
            aiBar.style.width = percentage + '%';
            aiLatency.textContent = 'High model inference latency';
            aiThreshold.textContent = aiData.latency + 'ms > ' + aiData.threshold + 'ms threshold';
            
            // Update Status Indicator
            const aiStatus = document.getElementById('aiStatus');
            if (aiData.latency > aiData.threshold) {
                aiStatus.className = 'px-2.5 py-0.5 bg-red-100 text-red-800 text-xs font-medium rounded-full';
                aiStatus.textContent = 'Critical';
                aiBar.className = 'h-full bg-red-500 rounded-full';
            } else if (aiData.latency > aiData.threshold * 0.9) {
                aiStatus.className = 'px-2.5 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full';
                aiStatus.textContent = 'Warning';
                aiBar.className = 'h-full bg-yellow-500 rounded-full';
            } else {
                aiStatus.className = 'px-2.5 py-0.5 bg-green-100 text-green-800 text-xs font-medium rounded-full';
                aiStatus.textContent = 'Normal';
                aiBar.className = 'h-full bg-green-500 rounded-full';
            }
            
            // Update last updated time
            lastUpdated.ai = new Date();
            document.getElementById('aiLastUpdated').textContent = 'Last updated: Just now';
        }
        
        function updateGpuTemperature(gpuData) {
            // In a real implementation, we would display GPU temperature metrics
            // This is mostly informational for the example
            console.log('GPU Temperature:', gpuData.temperature);
        }
        
        function updateTimestamps(metrics) {
            // Update all "last updated" timestamps
            const now = new Date();
            for (let [key, time] of Object.entries(lastUpdated)) {
                const diffMs = now - time;
                const diffMins = Math.round(diffMs / 60000);
                const diffSecs = Math.round(diffMs / 1000);
                
                let timeText;
                if (diffMins > 0) {
                    timeText = diffMins + ' minutes ago';
                } else {
                    timeText = diffSecs + ' seconds ago';
                }
                
                const element = document.getElementById(key + 'LastUpdated');
                if (element) {
                    element.textContent = 'Last updated: ' + timeText;
                }
            }
        }
        
        // Fetch alerts from API
        async function fetchAlerts() {
            try {
                const response = await fetch('/api/alerts?limit=5');
                const data = await response.json();
                
                if (data.success) {
                    updateAlertsDisplay(data.alerts);
                    
                    // Update alert counts if they're included in the response
                    if (data.counts) {
                        document.getElementById('criticalCount').textContent = data.counts.critical;
                        document.getElementById('warningCount').textContent = data.counts.warning;
                        document.getElementById('infoCount').textContent = data.counts.info;
                        document.getElementById('resolvedCount').textContent = data.counts.resolved;
                    }
                } else {
                    console.error('Error fetching alerts:', data.error);
                }
            } catch (error) {
                console.error('Failed to fetch alerts:', error);
            }
        }
        
        // Update alerts display
        function updateAlertsDisplay(alerts) {
            const alertsContainer = document.getElementById('alertsContainer');
            
            // Clear loading indicator
            alertsContainer.innerHTML = '';
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <div class="w-16 h-16 mx-auto mb-4 flex items-center justify-center bg-gray-100 rounded-full">
                            <i class="ri-checkbox-circle-line text-2xl text-gray-400"></i>
                        </div>
                        <p>No alerts to display</p>
                    </div>
                `;
                return;
            }
            
            // Add alerts to container
            alerts.forEach(alert => {
                // Determine icon and color based on level
                let iconClass, bgColorClass, textColorClass, borderColorClass;
                
                switch (alert.level) {
                    case 'critical':
                        iconClass = 'ri-error-warning-fill';
                        bgColorClass = 'bg-red-100';
                        textColorClass = 'text-red-600';
                        borderColorClass = 'alert-critical';
                        break;
                    case 'warning':
                        iconClass = 'ri-alert-line';
                        bgColorClass = 'bg-yellow-100';
                        textColorClass = 'text-yellow-600';
                        borderColorClass = 'alert-warning';
                        break;
                    case 'info':
                        iconClass = 'ri-information-line';
                        bgColorClass = 'bg-blue-100';
                        textColorClass = 'text-blue-600';
                        borderColorClass = 'alert-info';
                        break;
                    default:
                        iconClass = 'ri-checkbox-circle-line';
                        bgColorClass = 'bg-green-100';
                        textColorClass = 'text-green-600';
                        borderColorClass = 'alert-success';
                }
                
                // Format date
                const alertDate = new Date(alert.timestamp);
                const timeAgo = getTimeAgo(alertDate);
                
                // Create alert element
                const alertElement = document.createElement('div');
                alertElement.className = `p-4 alert-item ${borderColorClass}`;
                alertElement.dataset.alertId = alert.id;
                
                alertElement.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-10 h-10 flex items-center justify-center ${bgColorClass} ${textColorClass} rounded-full mr-3 shrink-0">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between">
                                <h4 class="font-medium text-gray-900">${alert.title}</h4>
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${alert.message}</p>
                            <div class="mt-3 flex items-center">
                                <button class="px-2.5 py-1 bg-white border border-gray-300 text-xs text-gray-700 rounded hover:bg-gray-50 mr-2 mark-read-btn">
                                    ${alert.is_read ? 'Mark Unread' : 'Mark Read'}
                                </button>
                                <button class="px-2.5 py-1 bg-white border border-gray-300 text-xs text-gray-700 rounded hover:bg-gray-50 resolve-btn">
                                    ${alert.is_resolved ? 'Reopen' : 'Resolve'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                alertsContainer.appendChild(alertElement);
                
                // Add event listeners
                const markReadBtn = alertElement.querySelector('.mark-read-btn');
                const resolveBtn = alertElement.querySelector('.resolve-btn');
                
                markReadBtn.addEventListener('click', () => {
                    updateAlertStatus(alert.id, { is_read: !alert.is_read });
                });
                
                resolveBtn.addEventListener('click', () => {
                    updateAlertStatus(alert.id, { is_resolved: !alert.is_resolved });
                });
            });
        }
        
        // Update alert status
        async function updateAlertStatus(alertId, updateData) {
            try {
                const response = await fetch(`/api/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                if (data.success) {
                    // Refresh alerts
                    fetchAlerts();
                } else {
                    console.error('Failed to update alert:', data.error);
                }
            } catch (error) {
                console.error('Error updating alert:', error);
            }
        }
        
        // Helper function to format time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.round(diffMs / 1000);
            const diffMins = Math.round(diffSecs / 60);
            const diffHours = Math.round(diffMins / 60);
            const diffDays = Math.round(diffHours / 24);
            
            if (diffSecs < 60) {
                return 'just now';
            } else if (diffMins < 60) {
                return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
            } else {
                return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
            }
        }
        
        // Update timestamps every minute
        function startTimestampUpdates() {
            setInterval(() => {
                updateTimestamps({});
            }, 60000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Alerts page loaded');
            
            // Initial data fetch
            fetchSystemMetrics();
            fetchAlerts();
            
            // Setup periodic updates every 5 seconds
            metricsUpdateTimer = setInterval(fetchSystemMetrics, 5000);
            const alertsUpdateTimer = setInterval(fetchAlerts, 30000);  // Update alerts every 30 seconds
            
            // Start timestamp updates
            startTimestampUpdates();
            
            // Add event listener for "View All Alerts" button
            document.getElementById('viewAllAlertsBtn').addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/alerts?limit=20');  // Get more alerts
                    const data = await response.json();
                    
                    if (data.success) {
                        updateAlertsDisplay(data.alerts);
                    } else {
                        console.error('Error fetching more alerts:', data.error);
                    }
                } catch (error) {
                    console.error('Failed to fetch more alerts:', error);
                }
            });
        });
    </script>
</body>
</html> 